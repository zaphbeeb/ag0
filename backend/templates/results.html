{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-white">Analysis Results</h1>
        <a href="/" class="text-blue-400 hover:text-blue-300 transition">&larr; Back to Search</a>
    </div>

    {% for res in results %}
    <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-white">{{ res.ticker }}</h2>
                <p class="text-gray-400">Best MA Pair: <span class="text-blue-400 font-semibold">{{ res.best_pair.short
                        }} / {{ res.best_pair.long }}</span></p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <p class="text-sm text-gray-400">Max Potential Gain</p>
                <p class="text-3xl font-bold {{ 'text-green-400' if res.max_gain > 0 else 'text-red-400' }}">
                    {{ "%.2f"|format(res.max_gain) }}%
                </p>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="relative h-96 w-full mb-6">
            <canvas id="chart-{{ loop.index }}"></canvas>
        </div>

        <!-- Optimization Details -->
        <div class="mt-4">
            <details class="group">
                <summary class="flex items-center cursor-pointer text-gray-300 hover:text-white transition">
                    <svg class="w-5 h-5 mr-2 transition-transform group-open:rotate-90" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    Show All Combinations
                </summary>
                <div class="mt-4 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 text-sm">
                        <thead class="bg-gray-900">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-300">EMA Pair</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-300">Gain %</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            {% for opt in res.optimization_results|sort(attribute='gain', reverse=True) %}
                            <tr class="hover:bg-gray-700 transition">
                                <td class="px-4 py-2 text-gray-300">{{ opt.pair }}</td>
                                <td
                                    class="px-4 py-2 text-right {{ 'text-green-400' if opt.gain > 0 else 'text-red-400' }}">
                                    {{ "%.2f"|format(opt.gain) }}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
    </div>

    <!-- Chart Data Storage -->
    <script id="data-{{ loop.index }}" type="application/json">
        {{ res.chart_data | tojson | safe }}
    </script>

    <!-- Chart Script -->
    <script>
        (function () {
            const ctx = document.getElementById('chart-{{ loop.index }}').getContext('2d');

            // Parse data from hidden JSON script to avoid linter errors
            const rawData = document.getElementById('data-{{ loop.index }}').textContent;
            const data = JSON.parse(rawData);

            // These will render as direct numbers, which is valid JS syntax
            const shortPeriod = {{ res.best_pair.short }
        };
        const longPeriod = {{ res.best_pair.long }};

        const labels = data.map(d => d.Date);
        const prices = data.map(d => d.Close);
        const emaShort = data.map(d => d[`EMA_${shortPeriod}`]);
        const emaLong = data.map(d => d[`EMA_${longPeriod}`]);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Price',
                        data: prices,
                        borderColor: '#9ca3af', // Gray-400
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: `EMA ${shortPeriod}`,
                        data: emaShort,
                        borderColor: '#3b82f6', // Blue-500
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: `EMA ${longPeriod}`,
                        data: emaLong,
                        borderColor: '#a855f7', // Purple-500
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: { color: '#e5e7eb' }
                    },
                    tooltip: {
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        backgroundColor: 'rgba(17, 24, 39, 0.9)'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month'
                        },
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af' }
                    }
                }
            }
        });
        }) ();
    </script>
    {% endfor %}
</div>
{% endblock %}